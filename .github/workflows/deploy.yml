- name: Deploy to EC2
  run: |
    ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
      TIMESTAMP=$(date +%Y%m%d%H%M%S)
      RELEASE_DIR=/home/ubuntu/Site/releases/$TIMESTAMP

      # 릴리즈 디렉토리 생성
      mkdir -p $RELEASE_DIR

      # 코드 복사
      git clone --depth=1 --branch develop https://github.com/your/repo.git $RELEASE_DIR

      cd $RELEASE_DIR

      composer install --no-dev --optimize-autoloader
      pnpm install
      pnpm run build

      # 심볼릭 링크 연결
      ln -sfn /home/ubuntu/Site/shared/storage $RELEASE_DIR/storage
      ln -sfn /home/ubuntu/Site/shared/bootstrap/cache $RELEASE_DIR/bootstrap/cache

      php artisan migrate --force
      php artisan config:cache
      php artisan route:cache
      php artisan view:cache

      # current 심볼릭 링크 교체 (무중단 배포 핵심)
      ln -sfn $RELEASE_DIR /home/ubuntu/Site/current

      echo "✅ Deployment to $RELEASE_DIR completed."
    EOF
